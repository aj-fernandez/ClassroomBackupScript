#!/bin/bash

# @author: ajfernandez
# @last_edit: 21/10/18
# @backupScript for classroom virtual machines

time=`date "+%d/%m/%Y %H:%M:%S"` # TODO: Get same time at every log entry,
# move `date..` into each log lines bellow [OK]

# usernames here
users=(
  "ajfernandez"
)                         # TODO: usernames, ip's and pass in csv file better?
userCount=${#users[@]}    # TODO: Implement hash of password using MD5 (MD5sum) or SHA-2
# end usernames

# sources
sources=(
  "192.168.2.1"
)
# end sources

log="/var/log/backupLog" # TODO: move to /var/log/backupLog [OK]
# TODO: is it possible integration with Syslog or journalctl? research about module "imjournal" []
echo "LOG at `date "+%d/%m/%Y %H:%M:%S"`-----------------------------" >> $log

for (( i=0; i < userCount; i++ )); do
  if [[ ! -d  /mnt/${users[i]} ]]; then
    mkdir /mnt/${users[i]}
    echo "Destination mount: /mnt/${users[i]} created succesfully" >> $log
  elif [[ ! -d  /home/${users[i]}/backupVM ]]; then
    mkdir /home/${users[i]}/backupVM
    echo "Destination directory: ${sources[i]} created succesfully" >> $log
  fi

mount -t cifs -o username=P2CTYPEUSERNAME,password=TYPEPASS //"${sources[i]}"/"${users[i]}"VM /mnt/"${users[i]}"/

if [ "$?" -eq 0 ]; then
  echo "Source directory: ${sources[i]} mounted succesfully" >> $log
else
  echo "Source directory: //${sources[i]}/${users[i]} failed to mount" >> $log
fi

echo "Initializing rsyn for: ${users[i]} ot `date "+%d/%m/%Y %H:%M:%S"`" >> $log
rsync -avh --progress /mnt/"${users[i]}" /home/"${users[i]}"/backupVM

if [ "$?" -eq 0 ]; then
  echo "Backup for: ${users[i]} SUCCESFULLY finished at `date "+%d/%m/%Y %H:%M:%S"` in /home/${users[i]}/backupVM" >> $log
  umount /mnt/"${users[i]}"
else
  echo "Backup for: ${users[i]} Rsync ERROR at `date "+%d/%m/%Y %H:%M:%S"` for ${users[i]}'s backup" >> $log
fi

done


# TODO: Unmount filesystems !! [OK] line 49

echo "LOG FINISHED at `date "+%d/%m/%Y %H:%M:%S"`--------------------" >> $log
printf "\n" >> $log


# TODO: GENERSL: Message with copied files in log and message if there aren't files to copy

# rsync -avh --progress /mnt/ajfernandez /home/ajfernandez/backupVM @@@ --delete, so dangerous!
# mount -t cifs -o username=TYPEUSERNAME //192.168.2.1/ajfernandezVM /mnt/ajfernandez/
# smbclient --list 192.168.2.1 --user=TYPEUSERNAME
# df -h show mounted filesystem free space
# $? reuturn exit code of previous command: if [ "$?" -eq "0" ] then echo "done" else echo "error"
# ${arr[*]}         All of the items in the array
# ${!arr[*]}        All of the indexes in the array
# ${#arr[*]}        Number of items in the array
# ${#arr[0]}        Length of item zero
# @ -> Do the same that '*' but when we acces to this spare each item as separated word
